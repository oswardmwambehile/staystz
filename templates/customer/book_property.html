{% extends 'customer/base.html' %}
{% load widget_tweaks %}
{% load static %}
{% load humanize %}

{% block content %}

<div class="container-fluid bg-white p-0">

    <!-- Navbar -->
    {% include 'customer/nav.html' %}

    <div class="container py-5">
        <div class="row g-4">

            <!-- LEFT: IMAGE CAROUSEL -->
            <div class="col-lg-6">
                <div id="propertyCarousel" class="carousel slide" data-bs-ride="carousel">

                    <div class="carousel-inner">
                        {% for photo in property.photos.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ photo.image.url }}" class="d-block w-100 custom-carousel-img" alt="">
                        </div>
                        {% empty %}
                        <div class="carousel-item active">
                            <img src="{% static 'images/no-image.png' %}" class="d-block w-100 custom-carousel-img" alt="">
                        </div>
                        {% endfor %}
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>

                    <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>

                </div>
            </div>

            <!-- RIGHT: FORM CARD -->
            <div class="col-lg-6">
                <div class="card p-4" style="background: transparent; border: 1px solid #d5d5d5; box-shadow: none; border-radius: 10px;">

                    <h3 class="text-center mb-3">{{ property.property_name|title }}</h3>

                    <!-- Base Price -->
                    <div class="alert alert-success text-center">
                        Price per night: 
                        <strong>{{ property.bookingpropertypricing.base_price_per_night|intcomma }} TZS</strong>
                    </div>

                    <form method="POST">
                        {% csrf_token %}

                        <!-- Room Type -->
                        <label class="form-label">Room Type</label>
                        {{ form.room_type|add_class:"form-select" }}

                        <!-- Dates -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Check-in</label>
                                {{ form.check_in|add_class:"form-control" }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Check-out</label>
                                {{ form.check_out|add_class:"form-control" }}
                            </div>
                        </div>

                        <!-- Guests -->
                        <div class="mt-3">
                            <label class="form-label">Guests</label>
                            {{ form.guests|add_class:"form-control" }}
                        </div>

                        <!-- Total Cost -->
                        <div class="alert alert-info text-center mt-3" id="totalBox" style="display:none;">
                            Total Cost: <strong id="totalPrice"></strong>
                        </div>
                        {% if form.errors %}
  <div class="alert alert-danger">
    {{ form.errors }}
  </div>
{% endif %}


                        <button type="submit" class="btn btn-primary w-100 mt-3 py-2">
                            Complete Booking
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- FEATURED PROPERTIES SECTION -->
<div class="container-fluid py-5">
    <div class="container">

        <h3 class="mb-4">Featured in {{ property.property_type|title }}</h3>

        <div class="tab-content">
            <div class="tab-pane fade show p-0 active">
                <div class="row g-4">

                    {% for property in featured_properties %}
                    <div class="col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="0.{{ forloop.counter0|add:"1" }}s">
                        <div class="property-item rounded overflow-hidden">

                            <div class="position-relative overflow-hidden">
                                <a href="{% url 'book_property' property.pk %}">
                                    {% if property.photos.first %}
                                        <img class="img-fluid" src="{{ property.photos.first.image.url }}" alt="{{ property.property_name }}">
                                    {% else %}
                                        <img class="img-fluid" src="{% static 'customer/img/property-placeholder.jpg' %}" alt="{{ property.property_name }}">
                                    {% endif %}
                                </a>

                                <div class="bg-primary rounded text-white position-absolute start-0 top-0 m-4 py-1 px-3"></div>

                                <div class="bg-white rounded-top text-primary position-absolute start-0 bottom-0 mx-4 pt-1 px-3">
                                    {{ property.property_type|title }}
                                </div>
                            </div>

                            <div class="p-4 pb-0">
                                <h5 class="text-primary mb-3">
                                    TZS {{ property.bookingpropertypricing.base_price_per_night|floatformat:0|intcomma }}/Night
                                </h5>
                                <a class="d-block h5 mb-2"
                                   href="{% url 'book_property' property.pk %}">{{ property.property_name|title }}</a>
                                <p><i class="fa fa-map-marker-alt text-primary me-2"></i>
                                    {{ property.address }}, {{ property.region }}
                                </p>
                            </div>

                            <div class="d-flex border-top">
                                <small class="flex-fill text-center border-end py-2">
                                    <i class="fa fa-ruler-combined text-primary me-2"></i>
                                    {{ property.property_size_sqm|default:"N/A" }} Sqft
                                </small>
                                <small class="flex-fill text-center border-end py-2">
                                    <i class="fa fa-bed text-primary me-2"></i>
                                    {{ property.bookingpropertysetup.total_beds|default:"N/A" }} Bed
                                </small>
                                <small class="flex-fill text-center py-2">
                                    <i class="fa fa-bath text-primary me-2"></i>
                                    {{ property.bookingpropertysetup.number_of_bathrooms|default:"N/A" }} Bath
                                </small>
                            </div>

                            <div class="p-4 pt-2">
                                <a href="{% url 'book_property' property.pk %}"
                                   class="btn btn-primary w-100">
                                   See Availability
                                </a>
                            </div>

                        </div>
                    </div>
                    {% empty %}
                        <p class="text-center text-danger">No featured properties found.</p>
                    {% endfor %}

                </div>
            </div>
        </div>

    </div>
</div>

<!-- AUTO CALCULATE PRICE JS -->
<script>
    const pricePerNight = {{ property.bookingpropertypricing.base_price_per_night }};
    const checkIn = document.getElementById("id_check_in");
    const checkOut = document.getElementById("id_check_out");
    const totalBox = document.getElementById("totalBox");
    const totalPrice = document.getElementById("totalPrice");

    function calcTotal() {
        const inDate = new Date(checkIn.value);
        const outDate = new Date(checkOut.value);

        if (inDate && outDate && outDate > inDate) {
            const nights = Math.ceil((outDate - inDate) / (1000 * 3600 * 24));
            const total = nights * pricePerNight;

            totalPrice.textContent = total.toLocaleString() + " TZS";
            totalBox.style.display = "block";
        }
    }

    checkIn.addEventListener("change", calcTotal);
    checkOut.addEventListener("change", calcTotal);
</script>

<!-- FIX CAROUSEL IMAGE HEIGHT -->
<style>
.custom-carousel-img {
    height: 420px;
    width: 100%;
    object-fit: cover;
    border-radius: 10px;
}
</style>

{% endblock %}
